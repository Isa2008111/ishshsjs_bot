
import vk_api
from vk_api.bot_longpoll import VkBotLongPoll, VkBotEventType
from datetime import datetime
import re

TOKEN = "–í–ê–®_–¢–û–ö–ï–ù"
GROUP_ID = –í–ê–®_ID

vk_session = vk_api.VkApi(token=TOKEN)
longpoll = VkBotLongPoll(vk_session, GROUP_ID)
vk = vk_session.get_api()

users = {}

def format_number(num):
    return f"{int(num):,}".replace(",", " ")

def get_keyboard(buttons):
    return {
        "one_time": False,
        "buttons": [[{"action": {"type": "text", "label": label}, "color": "primary"} for label in row] for row in buttons]
    }

def handle_start(user_id, username):
    if user_id not in users:
        users[user_id] = {
            "reg_date": datetime.now().strftime("%d-%m %H:%M"),
            "buy": 0,
            "sell": 0,
            "deals": 0
        }
    vk.messages.send(
        user_id=user_id,
        message=f"ü¶ã{username}, –¥–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ –º–∞—Ä–∫–µ—Ç!

–í–æ—Å–ø–æ–ª—å–∑—É–π—Ç–µ—Å—å –∫–ª–∞–≤–∏–∞—Ç—É—Ä–æ–π:",
        keyboard=str(get_keyboard([["–ö—É–ø–∏—Ç—å", "–ü—Ä–æ–¥–∞—Ç—å"], ["–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è", "–ò–≥—Ä–æ–≤–æ–π —á–∞—Ç"], ["–ü—Ä–æ—Ñ–∏–ª—å", "–ù–∞—Å—Ç—Ä–æ–π–∫–∏"], ["üå∑ –°–ª—É–∂–±–∞ –ø–æ–¥–¥–µ—Ä–∂–∫–∏"]])),
        random_id=0
    )

def handle_profile(user_id):
    u = users.get(user_id, {"buy": 0, "sell": 0, "deals": 0, "reg_date": "–Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–æ"})
    turnover = u["buy"] + u["sell"]
    vk.messages.send(
        user_id=user_id,
        message=f"üë§ –ü—Ä–æ—Ñ–∏–ª—å

üõçÔ∏è –ó–∞ –≤—Å—ë –≤—Ä–µ–º—è:
~ –ö—É–ø–ª–µ–Ω–æ: {format_number(u['buy'])} Byte
~ –ü—Ä–æ–¥–∞–Ω–æ: {format_number(u['sell'])} Byte
~ –û–±–æ—Ä–æ—Ç: {format_number(turnover)} Byte
~ –°–¥–µ–ª–æ–∫: {u['deals']}

üéâ –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è {u['reg_date']} –º–∞—è",
        random_id=0
    )

def handle_info(user_id):
    message = (
        "–ü—Ä–æ—Ü–µ—Å—Å–∏–Ω–≥ (RUB)
"
        "üìà –ú—ã –ø—Ä–æ–¥–∞—ë–º: 0.25 ‚Üí 1–ö Byte
"
        "üìâ –ú—ã –ø–æ–∫—É–ø–∞–µ–º: 0.20 ‚Üí 1–ö Byte
"
        "üí∞ –ú–æ–∂–µ–º —Å–∫—É–ø–∏—Ç—å: 8 000 000 Byte

"
        "–ö—Ä–∏–ø—Ç–æ–±–æ—Ç (RUB/USDT)
"
        "üìà –ú—ã –ø—Ä–æ–¥–∞—ë–º: 0.30 ‚Üí 1–ö Byte
"
        "üìâ –ú—ã –ø–æ–∫—É–ø–∞–µ–º: 0.10 ‚Üí 1–ö Byte
"
        "üí∞ –ú–æ–∂–µ–º —Å–∫—É–ø–∏—Ç—å: 1 165 968 Byte

"
        "–ö—Ä–∏–ø—Ç–æ–±–æ—Ç (RUB/TON)
"
        "üìà –ú—ã –ø—Ä–æ–¥–∞—ë–º: 0.30 ‚Üí 1–ö Byte
"
        "üìâ –ú—ã –ø–æ–∫—É–ø–∞–µ–º: 0.10 ‚Üí 1–ö Byte
"
        "üí∞ –ú–æ–∂–µ–º —Å–∫—É–ø–∏—Ç—å: 87 713 Byte

"
        "üå∑ –ú–æ–∂–µ–º –ø—Ä–æ–¥–∞—Ç—å: 7 104 000 Byte
"
        "üå∑ –ú–æ–∂–µ–º —Å–∫—É–ø–∏—Ç—å: 8 626 840 Byte

"
        "üåª –û–±–æ—Ä–æ—Ç –∑–∞ —Å–µ–≥–æ–¥–Ω—è: 16 496 000 Byte
"
        "üçÉ –ü—Ä–æ–≤–µ–¥–µ–Ω–æ —Å–¥–µ–ª–æ–∫ —Å–µ–≥–æ–¥–Ω—è: 19"
    )
    vk.messages.send(user_id=user_id, message=message, attachment="", random_id=0)

def handle_chat(user_id):
    vk.messages.send(user_id=user_id, message="üíÉüèª –ù–∞–π—Ç–∏ –±–µ—Å–µ–¥—É

–ó–∞–ª–µ—Ç–∞–π –≤ –∏–≥—Ä–æ–≤–æ–π —á–∞—Ç –æ–±–º–µ–Ω–Ω–∏–∫–∞:
@tejskl", random_id=0)

def handle_support(user_id):
    vk.messages.send(user_id=user_id, message="üå∑ –°–ª—É–∂–±–∞ –ø–æ–¥–¥–µ—Ä–∂–∫–∏

–ü–æ—Å–ª–µ–¥–Ω–∏–π –∑–∞–∫–∞–∑
–°–ø–∏—Å–æ–∫ –ø—É—Å—Ç

–°–±–æ—Ä–∫–∞ –æ—Ç 25-–≥–æ –∞–ø—Ä–µ–ª—è, 18:13", random_id=0)

# –ü—Ä–æ—Å—Ç–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è: —Ö—Ä–∞–Ω–µ–Ω–∏–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –∏ —Ä–∞—Å—Å—ã–ª–∫–∏
user_settings = {}

def handle_settings(user_id):
    settings = user_settings.get(user_id, {"notify": True, "mailing": True})
    notify = "üü¢–í–∫–ª" if settings["notify"] else "üî¥–í—ã–∫–ª"
    mailing = "üü¢–í–∫–ª" if settings["mailing"] else "üî¥–í—ã–∫–ª"
    vk.messages.send(
        user_id=user_id,
        message=f"‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –∞–∫–∫–∞—É–Ω—Ç–∞

–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è: {notify}
–†–∞—Å—Å—ã–ª–∫–∞: {mailing}",
        keyboard=str(get_keyboard([["–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è", "–†–∞—Å—Å—ã–ª–∫–∞"]])),
        random_id=0
    )

def toggle_setting(user_id, field):
    if user_id not in user_settings:
        user_settings[user_id] = {"notify": True, "mailing": True}
    user_settings[user_id][field] = not user_settings[user_id][field]
    handle_settings(user_id)

for event in longpoll.listen():
    if event.type == VkBotEventType.MESSAGE_NEW:
        user_id = event.obj.message['from_id']
        msg = event.obj.message['text'].strip()
        username = f"id{user_id}"
        msg_lower = msg.lower()

        if msg_lower == "/start":
            handle_start(user_id, username)
        elif msg == "–ü—Ä–æ—Ñ–∏–ª—å":
            handle_profile(user_id)
        elif msg == "–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è":
            handle_info(user_id)
        elif msg == "–ò–≥—Ä–æ–≤–æ–π —á–∞—Ç":
            handle_chat(user_id)
        elif msg == "üå∑ –°–ª—É–∂–±–∞ –ø–æ–¥–¥–µ—Ä–∂–∫–∏":
            handle_support(user_id)
        elif msg == "–ù–∞—Å—Ç—Ä–æ–π–∫–∏":
            handle_settings(user_id)
        elif msg == "–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è":
            toggle_setting(user_id, "notify")
        elif msg == "–†–∞—Å—Å—ã–ª–∫–∞":
            toggle_setting(user_id, "mailing"
